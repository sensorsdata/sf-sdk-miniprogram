var sensors=getApp().sensors;Component({options:{multipleSlots:!0},ready:function(){},lifetimes:{attached:function(){sensors.popupEmitter.attached()}},properties:{},data:{flag:!0,isShow:!1,template:{},image_list:[],image_load:{},msg:{$sf_msg_title:"",$sf_msg_content:"",$sf_msg_image_url:"",$sf_succeed:"",$sf_fail_reason:"",$sf_msg_id:""},plan:{}},methods:{loadImage:function(t){if(t&&t.length>0){var a=[].concat(this.image_list,t);this.setData({image_list:a})}},handle:function(t){if(this.data.flag){if(!t.popupTree&&!t.properties)return this.popupFail(1001),!1;this.initMessage(t),this.setData({template:t.popupTree}),this.setData({image_load:{}}),t.msg.plan&&this.setData({plan:t.msg.plan}),!t.msg.is_control_group&&this.data.flag?(this.setData({isShow:!0}),this.needLoadimageFirst()?this.loadimageFirst():this.showPopup()):this.popupFail(2e3)}},initMessage(t){var a=t.popupTree,e={$sf_msg_id:t.msg.uuid};e.$sf_msg_title=a.title?a.title.innerText:"",e.$sf_msg_content=a.content?a.content.innerText:"",e.$sf_msg_image_url=a.img?a.img.src:"",e.plan_id=t.msg.plan&&t.msg.plan.plan_id||"",e.$sf_audience_id=t.msg.plan&&t.msg.plan.audience_id||"",e.is_control_group=t.msg.is_control_group,this.setData({msg:e})},popupFail(t){var a=Object.assign({},this.data.msg);a.$sf_succeed=!1,a.fail_code=t,a.$sf_fail_reason={1000:"图片加载失败",1001:"预览信息解析失败，请检查计划配置",2000:"对照组"}[t],a.is_control_group=this.data.msg.is_control_group,2e3!==t?sensors.events.emit("popup_load_fail",a):sensors.events.emit("group_popup_display",a),sensors.events.emit("popup_end",this.data.plan)},clickMask:function(){if(this.data.template.properties.maskCloseEnabled){var t=Object.assign({},this.data.msg);t.$sf_msg_action_id=this.data.template.properties.maskActionId,t.$sf_close_type="POPUP_CLOSE_MASK",t.$sf_msg_element_type="mask",t.is_control_group=this.data.msg.is_control_group,sensors.events.emit("popup_click",t),this.hidePopup()}},hidePopup:function(){this.setData({flag:!0}),this.setData({isShow:!1}),sensors.events.emit("popup_end",this.data.plan)},showPopup(){if(this.data.msg.is_control_group)return!1;this.setData({flag:!1});var t=Object.assign({},this.data.msg);t.$sf_succeed=!0,t.is_control_group=this.data.msg.is_control_group,sensors.events.emit("popup_display",t)},tapContent(){console.log("点击了弹窗窗体")},topCloseButton(){var t=this.data.template.image_button;t.$sf_close_type||(t.$sf_close_type="POPUP_CLOSE_TOPRIGHT"),this.popupCLick(t)},buttomCloseButton(){var t=this.data.template.image_button;t.$sf_close_type||(t.$sf_close_type="POPUP_CLOSE_BOTTOM"),this.popupCLick(t)},clickImage(){var t=this.data.template.img;t.$sf_close_type||(t.$sf_close_type="POPUP_CLOSE_BUTTON"),this.popupCLick(t)},buttonFirst(){var t=this.data.template.button[0];"close"!==t.action_type||t.$sf_close_type||(t.$sf_close_type="POPUP_CLOSE_BUTTON"),this.popupCLick(t)},buttonSecond(){var t=this.data.template.button[1];"close"!==t.action_type||t.$sf_close_type||(t.$sf_close_type="POPUP_CLOSE_BUTTON"),this.popupCLick(t)},popupCLick(t){var a=Object.assign({},this.data.msg);switch(a.$sf_msg_element_type=t.type,a.$sf_msg_element_content=t.innerText,a.$sf_msg_action_id=t.id,a.action_value=t.value,a.$sf_msg_element_action=t.action_type,a.$sf_close_type=t.$sf_close_type,a.is_control_group=this.data.msg.is_control_group,t.action_type){case"copy":wx.setClipboardData({data:t.value,success(t){console.log("复制文本成功")}});break;case"navigateTo":a.action_value={path:t.path},this.navigatePage(a.action_value);break;case"navigateToMiniProgram":a.action_value={path:t.path,appid:t.appid},this.navigateMini(a.action_value)}sensors.events.emit("popup_click",a),t.closeable&&this.hidePopup()},navigatePage(t){wx.navigateTo({url:t.path,success:function(){console.log("navigate success")},fail:function(t){console.log("navigate fail: ",t)}})},navigateMini(t){wx.navigateToMiniProgram({appId:t.appid,path:t.path,success(){console.log("navigate success")},fail(t){console.log("navigate fail： ",t)}})},needLoadimageFirst(){return!!(this.data.template.img||this.isExistImageButton()||this.data.template.image_button&&!this.data.template.image_button.useLocalImage)},isExistImageButton(){if(!this.data.template.button||this.data.template.button.length<1)return!1;var t=this.data.template.button;for(var a in t)if("image_button"===t[a].type)return!0},loadimageFirst(){if(this.data.template.img&&this.setData({"image_load.image":0}),this.data.template.image_button&&(this.data.template.image_button.useLocalImage||this.setData({"image_load.image_button":0})),this.data.template.button&&this.data.template.button.length>0){var t=this.data.template.button;for(var a in t)"image_button"===t[a].type&&(0==a?this.setData({"image_load.first_button":0}):1==a&&this.setData({"image_load.second_button":0}))}},image(){this.setData({"image_load.image":1}),this.checkLoad()},imageError(t){console.log("load image error: ",t.detail),this.setData({"image_load.image":2}),this.checkLoad()},firstButton(){this.setData({"image_load.first_button":1}),this.checkLoad()},firstButtonError(t){console.log("load button error: ",t.detail),this.setData({"mage_load.first_button":2}),this.checkLoad()},secondButton(){this.setData({"image_load.second_button":1}),this.checkLoad()},secondButtonError(t){console.log("load button error: ",t.detail),this.setData({"mage_load.first_button":2}),this.checkLoad()},imageButton(){if(this.data.template.image_button.useLocalImage)return!1;this.setData({"image_load.image_button":1}),this.checkLoad()},imageButtonError(t){if(console.log("load  button error: ",t.detail),this.data.template.image_button.useLocalImage)return!1;this.setData({"mage_load.image_button":2}),this.checkLoad()},checkLoad(){var t=!0,a=!0,e=this.data.image_load;for(var s in e)0===e[s]?a=!1:2===e[s]&&(t=!1);a&&t&&this.showPopup(),a&&!t&&this.popupFail(1e3)}}});